<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Linux内核－非连续内存管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Linux内核－非连续内存管理"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-08-09 18:29:49 CST"/>
<meta name="author" content="visaya fan"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style><div id="menu">
             <p>
             <a href="#disqus_thread" >COMMENTS</a>
             </p>
            </div>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div>

<div id="preamble">
<a href="#" id="tabzilla" class="tabzilla-opened" role="button" aria-expanded="true" aria-controls="tabzilla-panel" title="Close (Esc)">No_Joking</a>
</div>

<div id="content">
<h1 class="title">Linux内核－非连续内存管理</h1>


<link rel="stylesheet" type="text/css" href="../css/bootstrap.mozilla.css" />
<link rel="stylesheet" type="text/css" href="../css/tabzilla.css" />
<link rel="stylesheet" type="text/css" href="../css/vf.css" />
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"> </script>
<script src="../js/tabzilla.js"></script>
<script src="../bootstrap/js/bootstrap.js"></script>
<script src="../js/disqus-comment.js"></script>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 简介</a></li>
<li><a href="#sec-2">2 非连续内存区域线性地址(逻辑地址)的表示范围</a></li>
<li><a href="#sec-3">3 非连续内存区域描述符</a></li>
<li><a href="#sec-4">4 获得/释放虚拟内存区域</a>
<ul>
<li><a href="#sec-4-1">4.1 get_vm_area</a></li>
<li><a href="#sec-4-2">4.2 remove_vm_area</a></li>
</ul>
</li>
<li><a href="#sec-5">5 分配/释放非连续内存区域</a>
<ul>
<li><a href="#sec-5-1">5.1 vmalloc</a></li>
<li><a href="#sec-5-2">5.2 vfree</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 简介</h2>
<div class="outline-text-2" id="text-1">

<p>  <a href="./mm.html">内存管理</a>中涉及的内存分配都是连续的，连续的内存分配有利于减小内存访问时间，但如果所有分配都使用连续内存分配的话，容易造成外部碎片，鉴于此原因，故对于不常访问的内存分配可以考虑非连续内存分配，虽然物理内存上是不连续的，但是通过页表可以使此不连续的内存在逻辑上连续的。<br/>
</p></div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 非连续内存区域线性地址(逻辑地址)的表示范围</h2>
<div class="outline-text-2" id="text-2">

<p>  从 <code>high_memory</code> 开始，之后有 <code>VMALLOC_OFFSET</code> (8M)安全间隔（捕获越界用），区域之间有4k的安全间隔， <code>PKMAP_BASE</code> 结束。之间的区域都可以用作非连续内存区域的线性地址。<br/>
  真正的非连续内存区域开始结束位置保存在两个宏中 <code>VMALLOC_START</code> 和 <code>VMALLOC_END</code> 。  <br/>
<center>
<img src="image/noncont_mem_area_addr.png"></img>
</center>
</p></div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 非连续内存区域描述符</h2>
<div class="outline-text-2" id="text-3">

<p>  每块非连续内存区域都对应一个描述符：<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span> {
<span class="linenr">2:  </span>    <span style="color: #228b22;">void</span>            *<span style="color: #a0522d;">addr</span>;      <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23545;&#24212;&#38750;&#36830;&#32493;&#20869;&#23384;&#21306;&#22495;&#30340;&#24320;&#22987;&#22320;&#22336; </span><span style="color: #b22222;">*/</span>
<span class="linenr">3:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>       <span style="color: #a0522d;">size</span>;   <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22823;&#23567; </span><span style="color: #b22222;">*/</span>
<span class="linenr">4:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>       <span style="color: #a0522d;">flags</span>;  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26631;&#24535; </span><span style="color: #b22222;">*/</span>
<span class="linenr">5:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span>     **<span style="color: #a0522d;">pages</span>;    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25351;&#21521;&#19968;&#20010;&#21547;&#26377;nr_pages&#20010;page&#25351;&#38024;&#30340;&#25968;&#32452;&#65292;&#26159;page&#30340;&#20108;&#32423;&#25351;&#38024; </span><span style="color: #b22222;">*/</span>
<span class="linenr">6:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">int</span>        <span style="color: #a0522d;">nr_pages</span>; <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#27492;&#21306;&#22495;&#20869;&#21547;&#26377;page&#20010;&#25968; </span><span style="color: #b22222;">*/</span>
<span class="linenr">7:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>       <span style="color: #a0522d;">phys_addr</span>; <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38500;&#38750;&#27492;&#21306;&#22495;&#34987;&#29992;&#26469;&#26144;&#23556;IO&#30828;&#20214;&#35774;&#22791;&#20849;&#20139;&#20869;&#23384;&#65292;&#21542;&#21017;&#32622;0 </span><span style="color: #b22222;">*/</span>
<span class="linenr">8:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span>    *<span style="color: #a0522d;">next</span>;     <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#29992;&#20110;&#38142;&#25509;&#38142;&#34920; </span><span style="color: #b22222;">*/</span>
<span class="linenr">9:  </span>};
</pre>

  描述符通过next成员连接成链表，表头为 <code>vmlist</code> ，<br/>
<center>
<img src="image/non_cont_area.jpeg"></img>
</center>
</p></div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 获得/释放虚拟内存区域</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> get_vm_area</h3>
<div class="outline-text-3" id="text-4-1">

<p>    struct vm_struct *get_vm_area(unsigned long size, unsigned long flags)<br/>
    参数size表示欲得到虚拟区域大小，flags表标志。<br/>
    实际上调用了 <code>__get_vm_area</code> 。<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #a020f0;">return</span> __get_vm_area(size, flags, VMALLOC_START, VMALLOC_END);
</pre>


<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span> *<span style="color: #0000ff;">__get_vm_area</span>(<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">size</span>, <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">flags</span>,
<span class="linenr"> 2:  </span>                <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">start</span>, <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">end</span>)
<span class="linenr"> 3:  </span>{
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span> **<span style="color: #a0522d;">p</span>, *<span style="color: #a0522d;">tmp</span>, *<span style="color: #a0522d;">area</span>;
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">align</span> = 1;
<span class="linenr"> 6:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">addr</span>;
<span class="linenr"> 7:  </span>
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">if</span> (flags &amp; VM_IOREMAP) {           <span style="color: #b22222;">/*</span><span style="color: #b22222;">&#22914;&#26524;&#26159;IOREMAP</span><span style="color: #b22222;">*/</span>
<span class="linenr"> 9:  </span>        <span style="color: #228b22;">int</span> <span style="color: #a0522d;">bit</span> = fls(size);            <span style="color: #b22222;">/*</span><span style="color: #b22222;">fls&#21462;&#24471;size&#26368;&#23567;&#30340;&#38750;0&#20301;&#65292;&#20998;&#26512;&#35265;&#19979;</span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>
<span class="linenr">11:  </span>        <span style="color: #a020f0;">if</span> (bit &gt; IOREMAP_MAX_ORDER)    
<span class="linenr">12:  </span>            bit = IOREMAP_MAX_ORDER;
<span class="linenr">13:  </span>        <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> (bit &lt; PAGE_SHIFT)
<span class="linenr">14:  </span>            bit = PAGE_SHIFT;
<span class="linenr">15:  </span>        align = 1ul &lt;&lt; bit;             <span style="color: #b22222;">/*</span><span style="color: #b22222;">&#35774;&#32622;&#23545;&#40784;&#22823;&#23567;</span><span style="color: #b22222;">*/</span>
<span class="linenr">16:  </span>    }
<span class="linenr">17:  </span>    addr = ALIGN(start, align); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23545;&#40784; </span><span style="color: #b22222;">*/</span>
<span class="linenr">18:  </span>
<span class="linenr">19:  </span>    area = kmalloc(<span style="color: #a020f0;">sizeof</span>(*area), GFP_KERNEL); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#34394;&#25311;&#20869;&#23384;&#21306;&#22495;&#25551;&#36848;&#31526;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">20:  </span>    <span style="color: #a020f0;">if</span> (unlikely(!area))
<span class="linenr">21:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">22:  </span>
<span class="linenr">23:  </span>    size += PAGE_SIZE;          <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22823;&#23567;&#65291;&#23433;&#20840;&#21306;&#22495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">24:  </span>    <span style="color: #a020f0;">if</span> (unlikely(!size)) {
<span class="linenr">25:  </span>        kfree (area);
<span class="linenr">26:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">27:  </span>    }
<span class="linenr">28:  </span>
<span class="linenr">29:  </span>    write_lock(&amp;vmlist_lock);   <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38145;&#20303;&#38142;&#34920; </span><span style="color: #b22222;">*/</span>
<span class="linenr">30:  </span>    <span style="color: #a020f0;">for</span> (p = &amp;vmlist; (tmp = *p) != <span style="color: #008b8b;">NULL</span> ;p = &amp;tmp-&gt;next) { <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#36941;&#21382;&#38142;&#34920;&#25214;&#21040;&#21512;&#36866;&#30340;&#21306;&#22495; </span><span style="color: #b22222;">*/</span>
<span class="linenr">31:  </span>        <span style="color: #a020f0;">if</span> ((<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>)tmp-&gt;addr &lt; addr) {
<span class="linenr">32:  </span>            <span style="color: #b22222;">/* </span><span style="color: #b22222;">addr&#22312;&#19968;&#20010;&#24050;&#32463;&#34987;&#20998;&#37197;&#30340;&#22320;&#22336;&#21306;&#22495;&#20869;&#37096;&#21017;&#20462;&#25913;addr&#20026;&#27492;&#22320;&#22336;&#21306;&#22495;&#22359;&#30340;&#26411;&#22320;&#22336;&#65288;&#23545;&#40784;&#65289; </span><span style="color: #b22222;">*/</span>
<span class="linenr">33:  </span>            <span style="color: #a020f0;">if</span>((<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>)tmp-&gt;addr + tmp-&gt;size &gt;= addr) 
<span class="linenr">34:  </span>                addr = ALIGN(tmp-&gt;size + 
<span class="linenr">35:  </span>                         (<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>)tmp-&gt;addr, align);
<span class="linenr">36:  </span>            <span style="color: #a020f0;">continue</span>;
<span class="linenr">37:  </span>        }
<span class="linenr">38:  </span>        <span style="color: #a020f0;">if</span> ((size + addr) &lt; addr)
<span class="linenr">39:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span>;
<span class="linenr">40:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25214;&#21040;&#21512;&#36866;&#30340;&#36830;&#32493;&#22320;&#22336;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">41:  </span>        <span style="color: #a020f0;">if</span> (size + addr &lt;= (<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>)tmp-&gt;addr)
<span class="linenr">42:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">found</span>;
<span class="linenr">43:  </span>        addr = ALIGN(tmp-&gt;size + (<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>)tmp-&gt;addr, align);
<span class="linenr">44:  </span>        <span style="color: #a020f0;">if</span> (addr &gt; end - size)
<span class="linenr">45:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">out</span>;
<span class="linenr">46:  </span>    }
<span class="linenr">47:  </span>
<span class="linenr">48:  </span><span style="color: #008b8b;">found</span>:
<span class="linenr">49:  </span>    area-&gt;next = *p;            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23558;&#27492;&#25551;&#36848;&#31526;&#25554;&#20837;&#21040;&#38142;&#34920;&#22836; </span><span style="color: #b22222;">*/</span>
<span class="linenr">50:  </span>    *p = area;
<span class="linenr">51:  </span>
<span class="linenr">52:  </span>    area-&gt;flags = flags;        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;&#26631;&#24535;&#65292;&#22320;&#22336;&#65292;&#22823;&#23567;&#65292;&#39029;&#20010;&#25968;&#31561;&#25104;&#21592; </span><span style="color: #b22222;">*/</span>
<span class="linenr">53:  </span>    area-&gt;addr = (<span style="color: #228b22;">void</span> *)addr;
<span class="linenr">54:  </span>    area-&gt;size = size;
<span class="linenr">55:  </span>    area-&gt;pages = <span style="color: #008b8b;">NULL</span>;
<span class="linenr">56:  </span>    area-&gt;nr_pages = 0;
<span class="linenr">57:  </span>    area-&gt;phys_addr = 0;
<span class="linenr">58:  </span>    write_unlock(&amp;vmlist_lock);
<span class="linenr">59:  </span>
<span class="linenr">60:  </span>    <span style="color: #a020f0;">return</span> area;
<span class="linenr">61:  </span>
<span class="linenr">62:  </span><span style="color: #008b8b;">out</span>:                            <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#27809;&#26377;&#21512;&#36866;&#30340;&#21306;&#22495;&#21017;&#37322;&#25918;&#38145;&#24182;&#37322;&#25918;&#24050;&#32463;&#20998;&#37197;&#30340;&#25551;&#36848;&#31526;&#31354;&#38388;&#65292;&#25171;&#21360;&#38169;&#35823;&#20449;&#24687; </span><span style="color: #b22222;">*/</span>
<span class="linenr">63:  </span>    write_unlock(&amp;vmlist_lock);
<span class="linenr">64:  </span>    kfree(area);
<span class="linenr">65:  </span>    <span style="color: #a020f0;">if</span> (printk_ratelimit())
<span class="linenr">66:  </span>        printk(KERN_WARNING <span style="color: #8b2252;">"allocation failed: out of vmalloc space - use vmalloc=&lt;size&gt; to increase size.\n"</span>);
<span class="linenr">67:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">68:  </span>}
</pre>

  <code>fls</code> 实际上调用了 <code>generic_fls</code> ：<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #b22222;">/*</span><span style="color: #b22222;">&#20989;&#25968;&#20316;&#29992;&#65306;&#21462;&#24471;x&#25152;&#26377;bit&#20013;&#38750;0&#30340;&#26368;&#23567;&#20301;</span><span style="color: #b22222;">*/</span>
<span class="linenr"> 2:  </span><span style="color: #a020f0;">static</span> __inline__ <span style="color: #228b22;">int</span> <span style="color: #0000ff;">generic_fls</span>(<span style="color: #228b22;">int</span> <span style="color: #a0522d;">x</span>)
<span class="linenr"> 3:  </span>{
<span class="linenr"> 4:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">r</span> = 32;
<span class="linenr"> 5:  </span>
<span class="linenr"> 6:  </span>    <span style="color: #a020f0;">if</span> (!x)
<span class="linenr"> 7:  </span>        <span style="color: #a020f0;">return</span> 0;
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">if</span> (!(x &amp; 0xffff0000u)) {
<span class="linenr"> 9:  </span>        x &lt;&lt;= 16;
<span class="linenr">10:  </span>        r -= 16;
<span class="linenr">11:  </span>    }
<span class="linenr">12:  </span>    <span style="color: #a020f0;">if</span> (!(x &amp; 0xff000000u)) {
<span class="linenr">13:  </span>        x &lt;&lt;= 8;
<span class="linenr">14:  </span>        r -= 8;
<span class="linenr">15:  </span>    }
<span class="linenr">16:  </span>    <span style="color: #a020f0;">if</span> (!(x &amp; 0xf0000000u)) {
<span class="linenr">17:  </span>        x &lt;&lt;= 4;
<span class="linenr">18:  </span>        r -= 4;
<span class="linenr">19:  </span>    }
<span class="linenr">20:  </span>    <span style="color: #a020f0;">if</span> (!(x &amp; 0xc0000000u)) {
<span class="linenr">21:  </span>        x &lt;&lt;= 2;
<span class="linenr">22:  </span>        r -= 2;
<span class="linenr">23:  </span>    }
<span class="linenr">24:  </span>    <span style="color: #a020f0;">if</span> (!(x &amp; 0x80000000u)) {
<span class="linenr">25:  </span>        x &lt;&lt;= 1;
<span class="linenr">26:  </span>        r -= 1;
<span class="linenr">27:  </span>    }
<span class="linenr">28:  </span>    <span style="color: #a020f0;">return</span> r;
<span class="linenr">29:  </span>}
</pre>

</p></div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> remove_vm_area</h3>
<div class="outline-text-3" id="text-4-2">


<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span> *<span style="color: #0000ff;">remove_vm_area</span>(<span style="color: #228b22;">void</span> *<span style="color: #a0522d;">addr</span>)
<span class="linenr"> 2:  </span>{
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span> **<span style="color: #a0522d;">p</span>, *<span style="color: #a0522d;">tmp</span>;
<span class="linenr"> 4:  </span>
<span class="linenr"> 5:  </span>    write_lock(&amp;vmlist_lock);
<span class="linenr"> 6:  </span>    <span style="color: #a020f0;">for</span> (p = &amp;vmlist ; (tmp = *p) != <span style="color: #008b8b;">NULL</span> ;p = &amp;tmp-&gt;next) {
<span class="linenr"> 7:  </span>         <span style="color: #a020f0;">if</span> (tmp-&gt;addr == addr)
<span class="linenr"> 8:  </span>             <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">found</span>;
<span class="linenr"> 9:  </span>    }
<span class="linenr">10:  </span>    write_unlock(&amp;vmlist_lock);
<span class="linenr">11:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">12:  </span>
<span class="linenr">13:  </span><span style="color: #008b8b;">found</span>:
<span class="linenr">14:  </span>    unmap_vm_area(tmp);         <span style="color: #b22222;">/*</span><span style="color: #b22222;">&#20998;&#26512;&#35265;vmalloc&#21644;vfree</span><span style="color: #b22222;">*/</span>
<span class="linenr">15:  </span>    *p = tmp-&gt;next;
<span class="linenr">16:  </span>    write_unlock(&amp;vmlist_lock);
<span class="linenr">17:  </span>    <span style="color: #a020f0;">return</span> tmp;
<span class="linenr">18:  </span>}
</pre>

</p></div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 分配/释放非连续内存区域</h2>
<div class="outline-text-2" id="text-5">


</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> vmalloc</h3>
<div class="outline-text-3" id="text-5-1">


<p><br/>
<pre class="src src-c"><span class="linenr">1:  </span><span style="color: #228b22;">void</span> *<span style="color: #0000ff;">vmalloc</span>(<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">size</span>)       <span style="color: #b22222;">/* </span><span style="color: #b22222;">size&#34920;&#27442;&#24471;&#21040;&#38750;&#36830;&#32493;&#20869;&#23384;&#21306;&#22495;&#30340;&#22823;&#23567;</span><span style="color: #b22222;">*/</span>
<span class="linenr">2:  </span>{
<span class="linenr">3:  </span>       <span style="color: #a020f0;">return</span> __vmalloc(size, GFP_KERNEL | __GFP_HIGHMEM, PAGE_KERNEL);
<span class="linenr">4:  </span>}
</pre>


<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">void</span> *<span style="color: #0000ff;">__vmalloc</span>(<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">size</span>, <span style="color: #228b22;">int</span> <span style="color: #a0522d;">gfp_mask</span>, <span style="color: #228b22;">pgprot_t</span> <span style="color: #a0522d;">prot</span>)
<span class="linenr"> 2:  </span>{
<span class="linenr"> 3:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span> *<span style="color: #a0522d;">area</span>;
<span class="linenr"> 4:  </span>    <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> **<span style="color: #a0522d;">pages</span>;
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">int</span> <span style="color: #a0522d;">nr_pages</span>, <span style="color: #a0522d;">array_size</span>, <span style="color: #a0522d;">i</span>;
<span class="linenr"> 6:  </span>
<span class="linenr"> 7:  </span>    size = PAGE_ALIGN(size);    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22823;&#23567;&#23545;&#40784; </span><span style="color: #b22222;">*/</span>
<span class="linenr"> 8:  </span>    <span style="color: #a020f0;">if</span> (!size || (size &gt;&gt; PAGE_SHIFT) &gt; num_physpages)
<span class="linenr"> 9:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">10:  </span>
<span class="linenr">11:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#25551;&#36848;&#31526;&#21450;&#22320;&#22336;&#31354;&#38388;&#65292;&#24182;&#35774;&#32622;&#20854;&#26631;&#24535;&#20301;VM_ALLOC&#65292;&#34920;&#26126;&#26159;&#36890;&#36807;vmalloc&#20998;&#37197;&#32780;&#26469; </span><span style="color: #b22222;">*/</span>
<span class="linenr">12:  </span>    area = get_vm_area(size, VM_ALLOC); 
<span class="linenr">13:  </span>    <span style="color: #a020f0;">if</span> (!area)
<span class="linenr">14:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">15:  </span>
<span class="linenr">16:  </span>    nr_pages = size &gt;&gt; PAGE_SHIFT;
<span class="linenr">17:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">vm_struct-&gt;pages&#25351;&#21521;array-size&#22823;&#23567;&#30340;&#25968;&#32452; </span><span style="color: #b22222;">*/</span>
<span class="linenr">18:  </span>    array_size = (nr_pages * <span style="color: #a020f0;">sizeof</span>(<span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> *));
<span class="linenr">19:  </span>
<span class="linenr">20:  </span>    area-&gt;nr_pages = nr_pages;
<span class="linenr">21:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#27492;&#36882;&#24402;&#32943;&#23450;&#21487;&#20197;&#32456;&#32467;&#65292;&#22240;&#20026;__vmalloc&#21442;&#25968;size&#20197;(2^PAGE_SHIFT/sizeof(struct page*))&#25351;&#25968;&#32423;&#19979;&#38477; </span><span style="color: #b22222;">*/</span>
<span class="linenr">22:  </span>    <span style="color: #a020f0;">if</span> (array_size &gt; PAGE_SIZE) <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22823;&#20110;&#19968;&#39029;&#65292;&#21017;&#36882;&#24402;&#35843;&#29992;&#27492;&#31243;&#24207; </span><span style="color: #b22222;">*/</span>
<span class="linenr">23:  </span>        pages = __vmalloc(array_size, gfp_mask, PAGE_KERNEL);
<span class="linenr">24:  </span>    <span style="color: #a020f0;">else</span>                        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#23567;&#20110;&#19968;&#39029;&#29992;kmalloc&#20998;&#37197; </span><span style="color: #b22222;">*/</span>
<span class="linenr">25:  </span>        pages = kmalloc(array_size, (gfp_mask &amp; ~__GFP_HIGHMEM));
<span class="linenr">26:  </span>    area-&gt;pages = pages;
<span class="linenr">27:  </span>    <span style="color: #a020f0;">if</span> (!area-&gt;pages) {         <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20998;&#37197;&#22833;&#36133; </span><span style="color: #b22222;">*/</span>
<span class="linenr">28:  </span>        remove_vm_area(area-&gt;addr); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37322;&#25918;&#22320;&#22336;&#31354;&#38388; </span><span style="color: #b22222;">*/</span>
<span class="linenr">29:  </span>        kfree(area);                <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#37322;&#25918;&#25551;&#36848;&#31526; </span><span style="color: #b22222;">*/</span>
<span class="linenr">30:  </span>        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">31:  </span>    }
<span class="linenr">32:  </span>    memset(area-&gt;pages, 0, array_size);
<span class="linenr">33:  </span>    <span style="color: #a020f0;">for</span> (i = 0; i &lt; area-&gt;nr_pages; i++) {
<span class="linenr">34:  </span>        area-&gt;pages[i] = alloc_page(gfp_mask); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25968;&#32452;&#20013;&#27599;&#39033;&#25351;&#21521;&#19968;&#20010;&#39029; </span><span style="color: #b22222;">*/</span>
<span class="linenr">35:  </span>        <span style="color: #a020f0;">if</span> (unlikely(!area-&gt;pages[i])) {       <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21322;&#36947;&#20986;&#38169;&#65292;&#26356;&#26032;area&#39029;&#20010;&#25968;&#25104;&#21151;&#20998;&#37197;&#30340;&#20010;&#25968; </span><span style="color: #b22222;">*/</span>
<span class="linenr">36:  </span>            area-&gt;nr_pages = i;
<span class="linenr">37:  </span>            <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">fail</span>;
<span class="linenr">38:  </span>        }
<span class="linenr">39:  </span>    }
<span class="linenr">40:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26356;&#26032;&#39029;&#34920;&#65292;&#20998;&#26512;&#35265;&#19979; </span><span style="color: #b22222;">*/</span>
<span class="linenr">41:  </span>    <span style="color: #a020f0;">if</span> (map_vm_area(area, prot, &amp;pages))
<span class="linenr">42:  </span>        <span style="color: #a020f0;">goto</span> <span style="color: #008b8b;">fail</span>;
<span class="linenr">43:  </span>    <span style="color: #a020f0;">return</span> area-&gt;addr;
<span class="linenr">44:  </span>
<span class="linenr">45:  </span><span style="color: #008b8b;">fail</span>:
<span class="linenr">46:  </span>    vfree(area-&gt;addr);
<span class="linenr">47:  </span>    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">NULL</span>;
<span class="linenr">48:  </span>}
</pre>

   要理解 <code>map_vm_area</code> 必须先理解linux内核的分页机制：<br/>
<center>
<img src="image/pgd_pud_pmd_pte.png"></img>
</center>
   <code>map_vm_area</code> 函数分析如下：<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #228b22;">int</span> <span style="color: #0000ff;">map_vm_area</span>(<span style="color: #a020f0;">struct</span> <span style="color: #228b22;">vm_struct</span> *<span style="color: #a0522d;">area</span>, <span style="color: #228b22;">pgprot_t</span> <span style="color: #a0522d;">prot</span>, <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> ***<span style="color: #a0522d;">pages</span>)
<span class="linenr"> 2:  </span>{
<span class="linenr"> 3:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">address</span> = (<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>) area-&gt;addr;
<span class="linenr"> 4:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">end</span> = address + (area-&gt;size-PAGE_SIZE);
<span class="linenr"> 5:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">next</span>;
<span class="linenr"> 6:  </span>    <span style="color: #228b22;">pgd_t</span> *<span style="color: #a0522d;">pgd</span>;
<span class="linenr"> 7:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">err</span> = 0;
<span class="linenr"> 8:  </span>    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>;
<span class="linenr"> 9:  </span>
<span class="linenr">10:  </span>    pgd = pgd_offset_k(address); <span style="color: #b22222;">/* </span><span style="color: #b22222;">address&#22312;&#20869;&#26680;&#39029;&#20840;&#23616;&#30446;&#24405;&#37324;&#30340;&#32034;&#24341; </span><span style="color: #b22222;">*/</span>
<span class="linenr">11:  </span>    spin_lock(&amp;init_mm.page_table_lock);
<span class="linenr">12:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">pdg_index(address)&#34920;&#31034;address&#22312;&#39029;&#20840;&#23616;&#30446;&#24405;&#37324;&#30340;&#32034;&#24341;&#65288;&#19982;pdg_offset_k&#21306;&#21035;&#65306;&#19981;&#26159;&#20869;&#26680;&#65289; </span><span style="color: #b22222;">*/</span>
<span class="linenr">13:  </span>    <span style="color: #a020f0;">for</span> (i = pgd_index(address); i &lt;= pgd_index(end-1); i++) {
<span class="linenr">14:  </span>        <span style="color: #228b22;">pud_t</span> *<span style="color: #a0522d;">pud</span> = pud_alloc(&amp;init_mm, pgd, address);
<span class="linenr">15:  </span>        <span style="color: #a020f0;">if</span> (!pud) {
<span class="linenr">16:  </span>            err = -ENOMEM;
<span class="linenr">17:  </span>            <span style="color: #a020f0;">break</span>;
<span class="linenr">18:  </span>        }
<span class="linenr">19:  </span>        next = (address + PGDIR_SIZE) &amp; PGDIR_MASK;
<span class="linenr">20:  </span>        <span style="color: #a020f0;">if</span> (next &lt; address || next &gt; end)
<span class="linenr">21:  </span>            next = end;
<span class="linenr">22:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;page upper directory </span><span style="color: #b22222;">*/</span>
<span class="linenr">23:  </span>        <span style="color: #a020f0;">if</span> (map_area_pud(pud, address, next, prot, pages)) {
<span class="linenr">24:  </span>            err = -ENOMEM;
<span class="linenr">25:  </span>            <span style="color: #a020f0;">break</span>;
<span class="linenr">26:  </span>        }
<span class="linenr">27:  </span>        address = next;
<span class="linenr">28:  </span>        pgd++;
<span class="linenr">29:  </span>    }
<span class="linenr">30:  </span>
<span class="linenr">31:  </span>    spin_unlock(&amp;init_mm.page_table_lock);
<span class="linenr">32:  </span>    flush_cache_vmap((<span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span>) area-&gt;addr, end);
<span class="linenr">33:  </span>    <span style="color: #a020f0;">return</span> err;
<span class="linenr">34:  </span>}
</pre>

   各级页目录和页表处理函数：<br/>
</p>
<p><br/>
<pre class="src src-c"><span class="linenr"> 1:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff;">map_area_pud</span>(<span style="color: #228b22;">pud_t</span> *<span style="color: #a0522d;">pud</span>, <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">address</span>,
<span class="linenr"> 2:  </span>                   <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">end</span>, <span style="color: #228b22;">pgprot_t</span> <span style="color: #a0522d;">prot</span>,
<span class="linenr"> 3:  </span>                   <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> ***<span style="color: #a0522d;">pages</span>)
<span class="linenr"> 4:  </span>{
<span class="linenr"> 5:  </span>    <span style="color: #a020f0;">do</span> {
<span class="linenr"> 6:  </span>        <span style="color: #228b22;">pmd_t</span> *<span style="color: #a0522d;">pmd</span> = pmd_alloc(&amp;init_mm, pud, address);
<span class="linenr"> 7:  </span>        <span style="color: #a020f0;">if</span> (!pmd)
<span class="linenr"> 8:  </span>            <span style="color: #a020f0;">return</span> -ENOMEM;
<span class="linenr"> 9:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;page middle directory </span><span style="color: #b22222;">*/</span>
<span class="linenr">10:  </span>        <span style="color: #a020f0;">if</span> (map_area_pmd(pmd, address, end - address, prot, pages))
<span class="linenr">11:  </span>            <span style="color: #a020f0;">return</span> -ENOMEM;
<span class="linenr">12:  </span>        address = (address + PUD_SIZE) &amp; PUD_MASK;
<span class="linenr">13:  </span>        pud++;
<span class="linenr">14:  </span>    } <span style="color: #a020f0;">while</span> (address &amp;&amp; address &lt; end);
<span class="linenr">15:  </span>
<span class="linenr">16:  </span>    <span style="color: #a020f0;">return</span> 0;
<span class="linenr">17:  </span>}
<span class="linenr">18:  </span>
<span class="linenr">19:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff;">map_area_pmd</span>(<span style="color: #228b22;">pmd_t</span> *<span style="color: #a0522d;">pmd</span>, <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">address</span>,
<span class="linenr">20:  </span>                   <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">size</span>, <span style="color: #228b22;">pgprot_t</span> <span style="color: #a0522d;">prot</span>,
<span class="linenr">21:  </span>                   <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> ***<span style="color: #a0522d;">pages</span>)
<span class="linenr">22:  </span>{
<span class="linenr">23:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">base</span>, <span style="color: #a0522d;">end</span>;
<span class="linenr">24:  </span>
<span class="linenr">25:  </span>    base = address &amp; PUD_MASK;
<span class="linenr">26:  </span>    address &amp;= ~PUD_MASK;
<span class="linenr">27:  </span>    end = address + size;
<span class="linenr">28:  </span>    <span style="color: #a020f0;">if</span> (end &gt; PUD_SIZE)
<span class="linenr">29:  </span>        end = PUD_SIZE;
<span class="linenr">30:  </span>
<span class="linenr">31:  </span>    <span style="color: #a020f0;">do</span> {
<span class="linenr">32:  </span>        <span style="color: #228b22;">pte_t</span> * <span style="color: #a0522d;">pte</span> = pte_alloc_kernel(&amp;init_mm, pmd, base + address);
<span class="linenr">33:  </span>        <span style="color: #a020f0;">if</span> (!pte)
<span class="linenr">34:  </span>            <span style="color: #a020f0;">return</span> -ENOMEM;
<span class="linenr">35:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22788;&#29702;page table entry </span><span style="color: #b22222;">*/</span>
<span class="linenr">36:  </span>        <span style="color: #a020f0;">if</span> (map_area_pte(pte, address, end - address, prot, pages))
<span class="linenr">37:  </span>            <span style="color: #a020f0;">return</span> -ENOMEM;
<span class="linenr">38:  </span>        address = (address + PMD_SIZE) &amp; PMD_MASK;
<span class="linenr">39:  </span>        pmd++;
<span class="linenr">40:  </span>    } <span style="color: #a020f0;">while</span> (address &lt; end);
<span class="linenr">41:  </span>
<span class="linenr">42:  </span>    <span style="color: #a020f0;">return</span> 0;
<span class="linenr">43:  </span>}
<span class="linenr">44:  </span>
<span class="linenr">45:  </span><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff;">map_area_pte</span>(<span style="color: #228b22;">pte_t</span> *<span style="color: #a0522d;">pte</span>, <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">address</span>,
<span class="linenr">46:  </span>                   <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">size</span>, <span style="color: #228b22;">pgprot_t</span> <span style="color: #a0522d;">prot</span>,
<span class="linenr">47:  </span>                   <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> ***<span style="color: #a0522d;">pages</span>)
<span class="linenr">48:  </span>{
<span class="linenr">49:  </span>    <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">long</span> <span style="color: #a0522d;">end</span>;
<span class="linenr">50:  </span>
<span class="linenr">51:  </span>    address &amp;= ~PMD_MASK;
<span class="linenr">52:  </span>    end = address + size;
<span class="linenr">53:  </span>    <span style="color: #a020f0;">if</span> (end &gt; PMD_SIZE)
<span class="linenr">54:  </span>        end = PMD_SIZE;
<span class="linenr">55:  </span>    <span style="color: #b22222;">/* </span><span style="color: #b22222;">pte&#37324;&#23384;&#25918;&#30340;&#26159;&#23454;&#38469;&#29289;&#29702;&#22320;&#22336;&#65292;&#23558;&#35201;&#25918;&#21040;&#26032;&#20998;&#37197;&#30340;&#39029;&#34920;&#23454;&#20307;&#37324; </span><span style="color: #b22222;">*/</span>
<span class="linenr">56:  </span>    <span style="color: #a020f0;">do</span> {
<span class="linenr">57:  </span>        <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">page</span> *<span style="color: #a0522d;">page</span> = **pages;
<span class="linenr">58:  </span>        WARN_ON(!pte_none(*pte));
<span class="linenr">59:  </span>        <span style="color: #a020f0;">if</span> (!page)
<span class="linenr">60:  </span>            <span style="color: #a020f0;">return</span> -ENOMEM;
<span class="linenr">61:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">mk_pte&#20998;&#37197;&#19968;&#20010;&#39029;&#34920;entry&#65292;&#24182;&#29992;set_pte&#20026;&#26032;&#20998;&#37197;&#30340;&#39029;&#34920;entry&#36171;&#20540;pte </span><span style="color: #b22222;">*/</span>
<span class="linenr">62:  </span>        <span style="color: #b22222;">/* </span><span style="color: #b22222;">pte&#26159;pte_t&#31867;&#22411;&#65292;&#20854;&#23454;&#26159;32b unsigned long&#21253;&#35013;&#32467;&#26500;&#20307; </span><span style="color: #b22222;">*/</span>
<span class="linenr">63:  </span>        set_pte(pte, mk_pte(page, prot));
<span class="linenr">64:  </span>        address += PAGE_SIZE;
<span class="linenr">65:  </span>        pte++;
<span class="linenr">66:  </span>        (*pages)++;
<span class="linenr">67:  </span>    } <span style="color: #a020f0;">while</span> (address &lt; end);
<span class="linenr">68:  </span>    <span style="color: #a020f0;">return</span> 0;
<span class="linenr">69:  </span>}
</pre>

</p></div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> vfree</h3>
<div class="outline-text-3" id="text-5-2">

<p>   和 <code>vmalloc</code> 相反，各级页目录和页表处理函数也相反。<br/>
</p>
<p><br/>
</p></div>
</div>
</div>
</div>

<div id="disqus_thread">
<p class="date">Date: 2012-08-09 18:29:49 CST</p>
<p class="author">Author: visaya fan</p>
<p class="creator">Org version 7.8.11 with Emacs version 23</p>


</div>
</body>
</html>
