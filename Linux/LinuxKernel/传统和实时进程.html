<?xml version="1.0" encoding="gb18030"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<title>ä¼ ç»Ÿå’Œå®æ—¶è¿›ç¨‹</title>
<meta http-equiv="Content-Type" content="text/html;charset=gb18030"/>
<meta name="title" content="ä¼ ç»Ÿå’Œå®æ—¶è¿›ç¨‹"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-12-14 09:05:25 CST"/>
<meta name="author" content="visayafan"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<div id="org-div-comments"><a href="../../index.html#linuxkernel">Ö÷Ò³</a></div>


</head>
<body>


<div id="content">
<h1 class="title">ä¼ ç»Ÿå’Œå®æ—¶è¿›ç¨‹</h1>


<!-- <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"> </script> -->
<link rel="stylesheet" type="text/css" href="../../Layout/CSS/bootstrap_old.css" />
<link rel="stylesheet" type="text/css" href="../../Layout/CSS/style.css" />
<script src="../../Layout/JS/jquery_1.7.1.js"></script>
<script src="../../Layout/JS/bootstrap_old.js"></script>



<div id="table-of-contents">
<h2>Ä¿Â¼</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 convential process</a>
<ul>
<li><a href="#sec-1-1">1.1 static priority</a></li>
<li><a href="#sec-1-2">1.2 dynamic priority</a></li>
</ul>
</li>
<li><a href="#sec-2">2 real-time process</a>
<ul>
<li><a href="#sec-2-1">2.1 static priority</a></li>
<li><a href="#sec-2-2">2.2 dynamic priority</a></li>
<li><a href="#sec-2-3">2.3 real time priority</a></li>
</ul>
</li>
<li><a href="#sec-3">3 µ÷¶È²ßÂÔ</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> convential process</h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> static priority</h3>
<div class="outline-text-3" id="text-1-1">

<p>   ·¶Î§Îª100-139(MAX_RT_PRIO - MAX_PRIO-1)<br/>
   ÄÚºË2.6ÖĞµÄ¾²Ì¬ÓÅÏÈ¼¶Ïàµ±ÓÚÄÚºË2.4ÖĞµÄniceÖµ£¬µ«×ªµ½MAX_RT_PRIOµ½MAX_PRIO-1È¡Öµ·¶Î§£¬Æä¹«Ê½Îª£º<br/>
   static priority = nice + 20 + MAX_RT_PRIO<br/>
   ÄÚºË¶¨ÒåÁ½¸öºêÀ´ÊµÏÖ´Ë×ª»¯£ºnice_to_prio() and prio_to_nice()<br/>
</p>


<pre class="src src-c++"><span style="color: #483d8b;">#define</span> <span style="color: #0000ff;">NICE_TO_PRIO</span>(<span style="color: #a0522d;">nice</span>)  (MAX_RT_PRIO + (nice) + 20)
<span style="color: #483d8b;">#define</span> <span style="color: #0000ff;">PRIO_TO_NICE</span>(<span style="color: #a0522d;">prio</span>)  ((prio) - MAX_RT_PRIO - 20)
</pre>

<p>
   ÔÚ½ø³Ìtask_structÖĞÓÃint static_prio±íÊ¾¡£<br/>
   Ò»¸ö½ø³Ì¼Ì³ĞÆä¸¸½ø³ÌµÄ¾²Ì¬ÓÅÏÈ¼¶¡£Ò²¿ÉÒÔÍ¨¹ınice() or setpriority()Ö¸¶¨¡£¾ö¶¨ÁËBase Time Quantum´óĞ¡¡£<br/>
</p><table  border="2" cellspacing="0" cellpadding="6" rules="all" frame="all">
<caption></caption>
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">static priority</th><th scope="col" class="left">Base Time Quantum</th></tr>
</thead>
<tbody>
<tr><td class="left">&lt; 120</td><td class="left">(140 - static priority) ¡Á 20</td></tr>
<tr><td class="left">&gt;= 120</td><td class="left">(140 - static priority) ¡Á 5</td></tr>
</tbody>
</table>





<pre class="src src-c++"><span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">DEF_TIMESLICE</span>       (100 * HZ / 1000)

<span style="color: #483d8b;">#define</span> <span style="color: #0000ff;">SCALE_PRIO</span>(<span style="color: #a0522d;">x</span>, <span style="color: #a0522d;">prio</span>) \
    max(x * (MAX_PRIO - prio) / (MAX_USER_PRIO/2), MIN_TIMESLICE)

<span style="color: #a020f0;">static</span> <span style="color: #228b22;">unsigned</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff;">task_timeslice</span>(<span style="color: #228b22;">task_t</span> *<span style="color: #a0522d;">p</span>)
{
    <span style="color: #a020f0;">if</span> (p-&gt;static_prio &lt; NICE_TO_PRIO(0))
        <span style="color: #a020f0;">return</span> SCALE_PRIO(DEF_TIMESLICE*4, p-&gt;static_prio);
    <span style="color: #a020f0;">else</span>
        <span style="color: #a020f0;">return</span> SCALE_PRIO(DEF_TIMESLICE, p-&gt;static_prio);
}
</pre>

<p>
DEF_TIMESLICE = 100, MAX_PRIO = 140, MAX_USER_PRIO = 40, ¹ÊµÃµ½ÉÏ±íÖĞµÄ¹«Ê½.<br/>
</p>
<p>
   ¾²Ì¬ÓÅÏÈ¼¶ÊıÖµÔ½´ó£¬½ø³ÌµÄÓÅÏÈ¼¶Ô½Ğ¡£¬·ÖÅäµÄ»ùÊ±¼äÁ¿¾ÍÔ½ÉÙ¡£<br/>
</p></div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> dynamic priority</h3>
<div class="outline-text-3" id="text-1-2">

<p>   ·¶Î§Óë¾²Ì¬ÓÅÏÈ¼¶ÏàÍ¬¡£<br/>
   ¶¯Ì¬ÓÅÏÈ¼¶ÊÇµ÷¶ÈÆ÷Ñ¡ÔñÒ»¸ö½ø³ÌÊ±Êµ¼Ê²Î¿¼µÄÖµ¡£<br/>
   dynamic priority = max( 100, min((static priority - bonus + 5), 139))<br/>
   ¼´¶¯Ì¬ÓÅÏÈ¼¶Óë¾²Ì¬ÓÅÏÈ¼¶ºÍbonusÖµÓĞ¹Ø£¬¶øbonusÈ¡Öµ·¶Î§Îª0-10£¬ÆäÖµ´óĞ¡ÓëÆ½¾ùË¯ÃßÊ±¼ä£¨average sleeping time£©ÓĞ¹Ø¡£<br/>
   Æ½¾ùË¯ÃßÊ±¼äÔ½´ó£¬bonusÖµÔ½´ó£¬Æä¶¯Ì¬ÓÅÏÈ¼¶Ô½´ó¡££¨Ë¯ÃßÊ±¼ä³¤ÁË×ÔÈ»ÒªÌá¸ßÆä¶¯Ì¬ÓÅÏÈ¼¶ÒÔ±ÜÃâ·¢Éú¼¢¶öÏÖÏó£©<br/>
   ÔÚtask_structÖĞÓÃint prioÀ´±íÊ¾¡£<br/>
   ¶¯Ì¬ÓÅÏÈ¼¶µÄ¼ÆËã¹ı³ÌÔÚ¸÷¸ö½ø³ÌµÄÔËĞĞ¹ı³ÌÖĞ½øĞĞ£¬Í¬Ê±Ó°Ïì¶¯Ì¬ÓÅÏÈ¼¶´óĞ¡µÄÒòËØ¼¯ÖĞ·´Ó³ÔÚsleep_avgÉÏ¡£<br/>
   task_structÖĞµÄ³ÉÔ±  unsigned long sleep_avg;<br/>
   ½ø³Ì´´½¨Ê±£¬ÔÚwake_up_forked_process()ÖĞ×Ó½ø³Ì¼Ì³ĞÁË¸¸½ø³ÌµÄ¶¯Ì¬ÓÅÏÈ¼¶£¬²¢Ìí¼Óµ½¸¸½ø³ÌµÄ¾ÍĞ÷¶ÓÁĞÖĞ£¬Èç¹û¸¸½ø³Ì²»ÔÚÈÎºÎ¾ÍĞ÷¶ÓÁĞÖĞ£¬ÔòÍ¨¹ıeffective_prio()À´¼ÆËã³ö×Ó½ø³ÌµÄ¶¯Ì¬ÓÅÏÈ¼¶²¢¸ù¾İ¼ÆËã½á¹û½«×Ó½ø³Ì·ÅÖÃµ½ÏàÓ¦µÄ¾ÍĞ÷¶ÓÁĞÖĞ¡£<br/>
   ¶¯Ì¬ÓÅÏÈ¼¶µÄ¼ÆËãÖ»ÒªÓÉeffective_prio()º¯ÊıÀ´Íê³É£º<br/>
</p>


<pre class="src src-c++"><span style="color: #a020f0;">static</span> <span style="color: #228b22;">int</span> <span style="color: #0000ff;">effective_prio</span>(<span style="color: #228b22;">task_t</span> *<span style="color: #a0522d;">p</span>)
{
    <span style="color: #228b22;">int</span> <span style="color: #a0522d;">bonus</span>, <span style="color: #a0522d;">prio</span>;

    <span style="color: #a020f0;">if</span> (rt_task(p))             ;;&#22914;&#26524;&#26159;&#23454;&#26102;&#36827;&#31243;&#21017;&#36820;&#22238;&#65288;&#23454;&#26102;&#36827;&#31243;&#30340;&#21160;&#24577;&#20248;&#20808;&#32423;&#26159;&#30001;setscheduler()&#20989;&#25968;&#35774;&#32622;&#19988;&#19968;&#32463;&#35774;&#32622;&#19981;&#20877;&#25913;&#21464;&#65289;
        <span style="color: #a020f0;">return</span> p-&gt;prio;

    bonus = CURRENT_BONUS(p) - MAX_BONUS / 2; ;;<span style="color: #228b22;">&#26681;&#25454;&#30561;&#30496;&#26102;&#38388;&#35774;&#32622;bonus&#20540;</span>

    <span style="color: #a0522d;">prio</span> = p-&gt;static_prio - bonus; ;;&#30001;&#38745;&#24577;&#20248;&#20808;&#32423;&#21644;bonus&#20540;&#26469;&#35774;&#32622;&#21160;&#24577;&#20248;&#20808;&#32423;
    <span style="color: #a020f0;">if</span> (prio &lt; MAX_RT_PRIO)        ;;&#21160;&#24577;&#20248;&#20808;&#32423;&#33539;&#22260;&#19981;&#33021;&#23567;&#20110;MAX_RT_PRIO&#20063;&#19981;&#33021;&#36229;&#36807;MAX_PRIO&#65292;&#25152;&#20197;&#27492;&#22788;&#20570;&#19979;&#21028;&#26029;&#12290;
        prio = MAX_RT_PRIO;
    <span style="color: #a020f0;">if</span> (prio &gt; MAX_PRIO-1)
        prio = MAX_PRIO-1;
    <span style="color: #a020f0;">return</span> prio;
}
</pre>



<pre class="src src-c++"><span style="color: #483d8b;">#define</span> <span style="color: #0000ff;">CURRENT_BONUS</span>(<span style="color: #a0522d;">p</span>) \
    (NS_TO_JIFFIES((p)-&gt;sleep_avg) * MAX_BONUS / \ ;;&#25226;&#30561;&#30496;&#26102;&#38388;&#36716;&#21270;&#20026;bonus&#20540;
        MAX_SLEEP_AVG)
</pre>

<p>
  ×î´óbonusÖµµÄ¼ÆËãÈçÏÂ£º<br/>
</p>


<pre class="src src-c++"><span style="color: #483d8b;">#define</span> <span style="color: #0000ff;">USER_PRIO</span>(<span style="color: #a0522d;">p</span>)        ((p)-MAX_RT_PRIO)
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">MAX_USER_PRIO</span>       (USER_PRIO(MAX_PRIO))       ;;40
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">PRIO_BONUS_RATIO</span>     25
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">MAX_BONUS</span>       (MAX_USER_PRIO * PRIO_BONUS_RATIO / 100) ;;&#32467;&#26524;&#20026;10
</pre>

<p>
  ×î´óÆ½¾ùË¯ÃßÊ±¼ä¼ÆËãÈçÏÂ£º<br/>
</p>


<pre class="src src-c++"><span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">DEF_TIMESLICE</span>       (100 * HZ / 1000)
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">MAX_SLEEP_AVG</span>       (DEF_TIMESLICE * MAX_BONUS)
</pre>

</div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> real-time process</h2>
<div class="outline-text-2" id="text-2">


</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> static priority</h3>
<div class="outline-text-3" id="text-2-1">

<p>   Óë·ÇÊµÊ±½ø³ÌÏàÍ¬¡£<br/>
</p></div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> dynamic priority</h3>
<div class="outline-text-3" id="text-2-2">

<p>   ÆäÖµÊÇÔÚsetscheduler()ÖĞÉèÖÃµÄÇÒÒ»¾­ÉèÖÃ±ã²»ÔÙ¸Ä±ä¡£<br/>
   ·ÇÊµÊ±½ø³ÌµÄ¶¯Ì¬ÓÅÏÈ¼¶»áÔÚ½ø³ÌÔËĞĞ¹ı³ÌÖĞ¶¯Ì¬¼ÆËã¶øÊµÊ±½ø³ÌµÄ¶¯Ì¬ÓÅÏÈ¼¶²»»á¸Ä±ä¡£<br/>
</p></div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> real time priority</h3>
<div class="outline-text-3" id="text-2-3">

<p>   Ã¿¸öÊµÊ±½ø³Ì¶¼ÓĞÒ»ÓëÆäÏà¹ØµÄÊµÊ±ÓÅÏÈ¼¶£¬È¡Öµ·¶Î§0-MAX_RT_PRIO-1¡£<br/>
   Æä´óĞ¡¿ÉÒÔÍ¨¹ısched_setscheduler()ºÍsched_setparam()À´¸Ä±ä¡£<br/>
   ÊµÊ±½ø³Ì±»Ò»¸ö½ø³ÌÌæ»»£¬¿ÉÄÜµÄÇé¿öÓĞ£º<br/>
</p><ol>
<li>½ø³Ì±»ÓµÓĞ¸ü¸ßÓÅÏÈ¼¶µÄ½ø³ÌÇÀÕ¼¡£<br/>
</li>
<li>½ø³Ì·¢Éú×èÈû½øÈëË¯Ãß×´Ì¬¡£<br/>
</li>
<li>½ø³Ì±»ÖÕÖ¹£¨×´Ì¬ÎªTASK_STOPPED OR TASK_TRACED£©»òÕß±»É±ËÀ£¨EXIT_DEAD OR EXIT_ZOMBIE£©¡£<br/>
</li>
<li>½ø³ÌÍ¨¹ıµ÷ÓÃsched_yield()×ÔÔ¸·ÅÆú´¦ÀíÆ÷¡£<br/>
</li>
<li>½ø³ÌÊÇÂÖ»ØÊµÊ±£¨SCHED_RR£©ÇÒÆäÊ±¼äÆ¬Ö´ĞĞÍê±Ï¡£<br/>
</li>
</ol>

<p>   µ±ÔÚSCHED_RRÊ±µ÷ÓÃnice()ºÍset_priority()º¯Êı²¢²»Ó°ÏìÊµÊ±ÓÅÏÈ¼¶£¬Ö»»áÓ°Ïì¾²Ì¬ÓÅÏÈ¼¶£¨´Ó¶øÓ°Ïì»ùÊ±¼äÆ¬£©¡£<br/>
</p></div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> µ÷¶È²ßÂÔ</h2>
<div class="outline-text-2" id="text-3">

<p>  task_structÖĞunsigned long policy;Ö¸¶¨µ÷¶È²ßÂÔ£¬ÆäÖµ¿ÉÒÔÈ¡:<br/>
</p>


<pre class="src src-c++"><span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">SCHED_NORMAL</span>    0       <span style="color: #b22222;">//</span><span style="color: #b22222;">&#38750;&#23454;&#26102;&#36827;&#31243;&#65292;&#22522;&#20110;&#20248;&#20808;&#32423;&#30340;&#36718;&#22238;&#27861;&#65288;Round Robin&#65289;</span>
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">SCHED_FIFO</span>      1       <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23454;&#26102;&#36827;&#31243;&#65292;&#20808;&#36827;&#20808;&#20986;</span>
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">SCHED_RR</span>        2       <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23454;&#26102;&#36827;&#31243;&#65292;&#22522;&#20110;&#20248;&#20808;&#32423;&#30340;&#36718;&#22238;&#27861;&#65288;Round Robin&#65289;</span>
</pre>

<script src="../../Layout/JS/disqus-comment.js"></script>
<div id="disqus_thread">
</div>
</div>
</div>
</div>

</body>
</html>
